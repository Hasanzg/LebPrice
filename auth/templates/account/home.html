{% extends 'header-footer.html' %}
{% load static %}

{% block title %}Home - LebPrice{% endblock %}

{% block content %}
<style>
  .main-content {
    padding: 30px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 30px;
    margin: 30px 0;
  }

  @media (max-width: 1200px) {
    .products-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .products-grid {
      grid-template-columns: 1fr;
    }
  }

  .product-card {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid #e0e0e0;
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .product-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.15);
  }

  .product-image-wrapper {
    position: relative;
    width: 100%;
    height: 280px;
    overflow: hidden;
    background: #f5f5f5;
  }

  .product-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s;
  }

  .product-card:hover img {
    transform: scale(1.05);
  }

  .product-info {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    flex-grow: 1;
  }

  .product-card h3 {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
    color: #2d3436;
    line-height: 1.4;
    min-height: 44px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .product-card .store {
    font-size: 13px;
    color: #636e72;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .product-card .price {
    font-size: 26px;
    font-weight: 700;
    color: #2d7a4f;
    margin: 8px 0;
  }

  .add-to-cart-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #2d7a4f 0%, #1a472a 100%);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: auto;
  }

  .add-to-cart-btn:hover {
    background: linear-gradient(135deg, #1a472a 0%, #0d2515 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(45, 122, 79, 0.4);
  }

  .no-products {
    text-align: center;
    padding: 100px 20px;
    color: #636e72;
  }

  .no-products h2 {
    font-size: 32px;
    margin-bottom: 15px;
    color: #2d3436;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin: 50px 0 30px 0;
    flex-wrap: wrap;
  }

  .pagination a, .pagination span {
    padding: 12px 20px;
    background: white;
    border-radius: 10px;
    text-decoration: none;
    color: #2d3436;
    border: 2px solid #e0e0e0;
    transition: all 0.3s;
    font-weight: 600;
    min-width: 50px;
    text-align: center;
  }

  .pagination a:hover {
    background: #2d7a4f;
    color: white;
    border-color: #2d7a4f;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(45, 122, 79, 0.3);
  }

  .pagination .current {
    background: linear-gradient(135deg, #2d7a4f 0%, #1a472a 100%);
    color: white;
    border-color: #2d7a4f;
  }

  .pagination .disabled {
    opacity: 0.3;
    cursor: not-allowed;
    pointer-events: none;
  }

  /* Product Detail Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.75);
    overflow: auto;
    backdrop-filter: blur(5px);
  }

  .modal-content {
    background-color: white;
    margin: 2% auto;
    padding: 0;
    border-radius: 20px;
    width: 90%;
    max-width: 1000px;
    position: relative;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    overflow: hidden;
  }

  .modal-header {
    padding: 25px 30px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .close-modal {
    color: #636e72;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
    transition: color 0.3s;
    background: none;
    border: none;
    padding: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }

  .close-modal:hover {
    color: #2d7a4f;
    background: #f5f5f5;
  }

  .modal-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    padding: 30px;
  }

  .modal-image {
    position: relative;
  }

  .modal-image img {
    width: 100%;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .modal-info {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .modal-info h2 {
    font-size: 28px;
    margin: 0;
    color: #2d3436;
    line-height: 1.3;
  }

  .modal-store {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #636e72;
    font-size: 15px;
    padding: 10px 15px;
    background: #f5f5f5;
    border-radius: 8px;
    width: fit-content;
  }

  .modal-category {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    background: #2d7a4f;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    width: fit-content;
    font-weight: 600;
  }

  .modal-price {
    font-size: 38px;
    font-weight: 700;
    color: #2d7a4f;
    margin: 10px 0;
  }

  .modal-description {
    line-height: 1.8;
    color: #2d3436;
    font-size: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #2d7a4f;
  }

  .modal-actions {
    display: flex;
    gap: 15px;
    margin-top: 20px;
  }

  .modal-link, .modal-add-cart {
    flex: 1;
    padding: 16px 24px;
    text-decoration: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s;
    cursor: pointer;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .modal-link {
    background: white;
    color: #2d7a4f;
    border: 2px solid #2d7a4f;
  }

  .modal-link:hover {
    background: #2d7a4f;
    color: white;
  }

  .modal-add-cart {
    background: linear-gradient(135deg, #2d7a4f 0%, #1a472a 100%);
    color: white;
  }

  .modal-add-cart:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(45, 122, 79, 0.4);
  }

  @media (max-width: 768px) {
    .modal-grid {
      grid-template-columns: 1fr;
      gap: 25px;
    }

    .modal-actions {
      flex-direction: column;
    }
  }
</style>

<div class="main-content">
  <!-- Products Grid -->
  {% if products %}
    <div class="products-grid">
      {% for product in products %}
        <div class="product-card" 
             data-id="{{ product.id }}"
             data-name="{{ product.product_name|default:'Unnamed Product' }}"
             data-price="{{ product.price|default:'' }}"
             data-description="{{ product.description|default:'No description available' }}"
             data-image="{{ product.image_url|default:'' }}"
             data-url="{{ product.product_url|default:'' }}"
             data-store="{{ product.store_name|default:'Unknown Store' }}"
             data-category="{{ product.category|default:'' }}"
             onclick="showProductDetail(this)">
          
          <div class="product-image-wrapper">
            {% if product.image_url %}
              <img src="{{ product.image_url }}" alt="{{ product.product_name }}" 
                   onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
            {% else %}
              <img src="https://via.placeholder.com/400x300?text=No+Image" alt="{{ product.product_name }}">
            {% endif %}
          </div>

          <div class="product-info">
            <h3>{{ product.product_name|truncatechars:70 }}</h3>
            <p class="store">üì¶ {{ product.store_name|default:"Unknown Store" }}</p>

            {% if product.price %}
              <p class="price">${{ product.price }}</p>
            {% else %}
              <p class="price" style="color: #636e72; font-size: 18px;">Price unavailable</p>
            {% endif %}

<button class="add-to-cart-btn" 
        data-product-id="{{ product.id }}"
        onclick="event.stopPropagation(); addToCart(this.getAttribute('data-product-id'))">
  <span>üõí</span>
  <span>Add to Cart</span>
</button>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.num_pages > 1 %}
    <div class="pagination">
      {% if page_obj.has_previous %}
        <a href="?page=1{% if querystring %}&{{ querystring }}{% endif %}">¬´ First</a>
        <a href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">¬´ Previous</a>
      {% else %}
        <span class="disabled">¬´ First</span>
        <span class="disabled">¬´ Previous</span>
      {% endif %}

      <span class="current">
        Page {{ page_obj.number }} of {{ page_obj.num_pages }}
      </span>

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">Next ‚Ä∫</a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% if querystring %}&{{ querystring }}{% endif %}">Last ¬ª</a>
      {% else %}
        <span class="disabled">Next ‚Ä∫</span>
        <span class="disabled">Last ¬ª</span>
      {% endif %}
    </div>
    {% endif %}

  {% else %}
    <div class="no-products">
      <h2>üîç No products found</h2>
      <p>Try adjusting your search or filters</p>
      {% if search %}
        <p>Searched for: <strong>"{{ search }}"</strong></p>
      {% endif %}
    </div>
  {% endif %}
</div>

<!-- Product Detail Modal -->
<div id="productModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 style="margin: 0; font-size: 24px; color: #2d3436;">Product Details</h2>
      <button class="close-modal" onclick="closeModal()">&times;</button>
    </div>
    
    <div class="modal-grid">
      <div class="modal-image">
        <img id="modalImage" src="" alt="">
      </div>
      
      <div class="modal-info">
        <h2 id="modalTitle"></h2>
        
        <div class="modal-store" id="modalStore"></div>
        
        <div id="modalCategoryWrapper"></div>
        
        <div class="modal-price" id="modalPrice"></div>
        
        <div class="modal-description" id="modalDescription"></div>
        
        <div class="modal-actions">
          <a id="modalLink" href="#" target="_blank" class="modal-link">
            üîó View on Store
          </a>
          <button class="modal-add-cart" onclick="addToCartFromModal()">
            üõí Add to Cart
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let currentProductId = null;

function showProductDetail(element) {
  // Get data from data attributes
  const id = element.getAttribute('data-id');
  const name = element.getAttribute('data-name');
  const price = element.getAttribute('data-price');
  const description = element.getAttribute('data-description');
  const imageUrl = element.getAttribute('data-image');
  const productUrl = element.getAttribute('data-url');
  const store = element.getAttribute('data-store');
  const category = element.getAttribute('data-category');
  
  currentProductId = id;
  
  document.getElementById('modalTitle').textContent = name;
  document.getElementById('modalStore').innerHTML = 'üì¶ ' + store;
  
  // Handle category
  const categoryWrapper = document.getElementById('modalCategoryWrapper');
  if (category && category !== 'None' && category !== '') {
    categoryWrapper.innerHTML = `<div class="modal-category">üè∑Ô∏è ${category}</div>`;
  } else {
    categoryWrapper.innerHTML = '';
  }
  
  // Handle price
  const priceElement = document.getElementById('modalPrice');
  if (price && price !== 'None' && price !== '') {
    priceElement.textContent = '$' + price;
  } else {
    priceElement.innerHTML = '<span style="color: #636e72; font-size: 24px;">Price unavailable</span>';
  }
  
  // Handle description
  const descElement = document.getElementById('modalDescription');
  if (description && description !== 'None' && description !== 'No description available' && description !== '') {
    descElement.textContent = description;
  } else {
    descElement.innerHTML = '<em style="color: #636e72;">No description available for this product.</em>';
  }
  
  // Handle image
  const modalImage = document.getElementById('modalImage');
  if (imageUrl && imageUrl !== 'None' && imageUrl !== '') {
    modalImage.src = imageUrl;
  } else {
    modalImage.src = 'https://via.placeholder.com/500x400?text=No+Image+Available';
  }
  
  // Handle product URL
  const modalLink = document.getElementById('modalLink');
  if (productUrl && productUrl !== 'None' && productUrl !== '') {
    modalLink.href = productUrl;
    modalLink.style.display = 'flex';
  } else {
    modalLink.style.display = 'none';
  }
  
  document.getElementById('productModal').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('productModal').style.display = 'none';
  document.body.style.overflow = 'auto';
  currentProductId = null;
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('productModal');
  if (event.target == modal) {
    closeModal();
  }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeModal();
  }
});

// Add to cart function
function addToCart(productId) {
  fetch(`http://localhost:8000/products/cart/add/${productId}/`, {
    method: 'POST',
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.message) {
      // Create success notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #2d7a4f 0%, #1a472a 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        z-index: 10000;
        font-weight: 600;
        font-size: 15px;
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = '‚úÖ ' + data.message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error adding to cart');
  });
}

function addToCartFromModal() {
  if (currentProductId) {
    addToCart(currentProductId);
  }
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);
</script>

{% endblock %}